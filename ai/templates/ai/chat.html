<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Assist AI</title>

  {% csrf_token %}
  <input type="hidden" id="csrf-token" value="{{ csrf_token }}">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <style>
    /* -----------------------------------
    DEFAULT LIGHT THEME VARIABLES
    ----------------------------------- */
    :root{
    --sidebar-width:72px;

    /* light mode */
    --bg:#f7f7f8;
    --card:#ffffff;
    --text:#111;
    --border:#e6e6e6;
    --muted:#6c757d;
    --msg-user:#dcecff;
    --msg-bot:#ffffff;
    --msg-user-border:#bcd7ff;
    --msg-bot-border:#dcdcdc;
    }

    /* -----------------------------------
    DARK MODE VARIABLES
    ----------------------------------- */
    .dark-mode {
    --bg:#1e1f22;
    --card:#2b2d31;
    --text:#f2f2f2;
    --border:#3a3b3e;
    --muted:#b0b0b5;
    --msg-user:#3a5570;
    --msg-bot:#2f3136;
    --msg-user-border:#4f7293;
    --msg-bot-border:#3f4147;
    }

    /* -----------------------------------
    BASE LAYOUT
    ----------------------------------- */
    html,body{height:100%}
    body {
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family:system-ui, sans-serif;
    display:flex; min-height:100vh;
    overflow:hidden;
    }

    /* -----------------------------------
    SIDEBAR
    ----------------------------------- */
    #sidebar {
    width: var(--sidebar-width);
    background: var(--card);
    border-right:1px solid var(--border);
    display:flex; flex-direction:column;
    align-items:center; padding:14px 6px;
    gap:8px;
    }
    #sidebar .icon {
    width:46px;height:46px;border-radius:10px;
    display:flex; align-items:center; justify-content:center;
    cursor:pointer; color:var(--text);
    border:1px solid transparent;
    }
    #sidebar .icon:hover {
    background:rgba(255,255,255,0.1);
    border-color:var(--border);
    }

    /* -----------------------------------
    LEFT PANEL (HISTORY)
    ----------------------------------- */
    #leftpanel {
    width:260px; background:var(--card);
    border-right:1px solid var(--border);
    display:none; flex-direction:column;
    }
    #leftpanel .search {
    padding:8px 12px; margin:8px;
    border-radius:12px;
    background:var(--card);
    color:var(--text);
    border:1px solid var(--border);
    }
    #leftpanel .search::placeholder{
    color:var(--muted);
    }

    #convo-list { overflow:auto; padding:8px; flex:1; }

    /* Chat list items */
    .convo-item {
    padding:10px 12px; border-radius:10px;
    cursor:pointer; margin-bottom:6px;
    color:var(--text);
    }
    .convo-item:hover {
    background:rgba(255,255,255,0.07);
    }
    .convo-item.active {
    background:rgba(90,130,255,0.2);
    }
    .convo-title { font-weight:600; }
    .convo-meta { font-size:12px; color:var(--muted); }

    /* -----------------------------------
    MAIN AREA
    ----------------------------------- */
    #main { flex:1; display:flex; flex-direction:column; min-width:0; }

    #topbar {
    height:64px; display:flex; align-items:center;
    gap:12px; padding:0 18px;
    background:var(--card); border-bottom:1px solid var(--border);
    font-size:18px; font-weight:700;
    color:var(--text);
    }

    /* Chat area */
    #chat-area {
    flex:1; overflow:auto; padding:30px;
    display:flex; flex-direction:column; gap:18px;
    }

    /* Messages */
    .msg-wrapper { max-width:78%; }
    .msg {
    padding:14px 18px; border-radius:14px;
    border:1px solid var(--msg-bot-border);
    background:var(--msg-bot);
    color:var(--text);
    }
    .user {
    align-self:flex-end;
    background:var(--msg-user);
    border-color:var(--msg-user-border);
    }
    .bot {
    align-self:flex-start;
    }

    /* Input bar */
    #input-bar {
    background:var(--card); border-top:1px solid var(--border);
    padding:12px; display:flex; gap:10px; align-items:center;
    }
    #input-box {
    flex:1; border-radius:22px; padding:12px 16px;
    border:1px solid var(--border);
    background:var(--card);
    color:var(--text);
    }
    #input-box::placeholder { color:var(--muted); }

    #send-btn {
    width:48px; height:48px; border-radius:50%;
    }

    /* -----------------------------------
    CONTEXT MENU
    ----------------------------------- */
    #context-menu {
    position:absolute; display:none; z-index:9999;
    background:var(--card);
    border:1px solid var(--border);
    border-radius:8px;
    box-shadow:0 4px 12px rgba(0,0,0,0.25);
    padding:6px 0; width:160px;
    }
    .ctx-item {
    padding:8px 14px;
    cursor:pointer;
    color:var(--text);
    }
    .ctx-item:hover { background:rgba(255,255,255,0.08); }
    .ctx-item[data-action="delete"]{ color:#ff5555; }

    /* -----------------------------------
    RESPONSIVE
    ----------------------------------- */
    @media (max-width: 900px) {
    #sidebar { width:58px; }
    #chat-area { padding:18px; }
    #leftpanel { display:none; }
    }

    /* Welcome screen (center like ChatGPT) */
    #welcome-screen {
      text-align: center;
      margin-top: 120px;
      color: var(--text);
      opacity: 0.9;
    }

    #welcome-screen h1 {
      font-size: 32px;
      font-weight: 700;
    }

    #welcome-screen p {
      font-size: 18px;
      margin-top: 8px;
      opacity: 0.8;
    }

    </style>
</head>
<body>

<!-- Sidebar -->
<div id="sidebar">
  <div class="icon" id="btn-new"><i class="bi bi-plus-lg"></i></div>
  <div class="icon" id="btn-history"><i class="bi bi-list-ul"></i></div>
  <div style="flex:1"></div>
  <div class="icon" id="btn-settings"><i class="bi bi-gear"></i></div>
</div>

<!-- History Panel -->
<div id="leftpanel">
  <div style="padding:10px 14px; font-weight:700; font-size:15px;">Chats</div>
  <input id="search-input" class="form-control search" placeholder="Search chats..." />
  <div id="convo-list"></div>
</div>

<!-- Main Chat Area -->
<div id="main">

  <div id="topbar">Assist AI</div>

  <div id="welcome-screen">
      <h1>Meet Assist AI</h1>
      <p>Your personal AI assistant</p>
  </div>

  <div id="chat-area"></div>

  <div id="loader" style="display:none;padding:8px 18px;color:#666;">
    <i class="bi bi-three-dots"></i> Thinking...
  </div>

  <div id="input-bar">
    <input id="input-box" placeholder="Send a message..." />
    <button id="send-btn" class="btn btn-dark"><i class="bi bi-send-fill"></i></button>
  </div>
</div>


<!-- Right-click menu -->
<div id="context-menu">
  <div class="ctx-item" data-action="rename">Rename</div>
  <div class="ctx-item" data-action="delete">Delete</div>
</div>

<!-- SETTINGS MODAL -->
<div id="settings-modal" 
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.4); backdrop-filter:blur(3px);
            justify-content:center; align-items:center; z-index:9999;">

  <div style="width:380px; background:var(--card); color:var(--text);
              padding:20px; border-radius:14px; border:1px solid var(--border);">

    <h5 style="margin-bottom:15px;">General</h5>

    <label class="form-label">Appearance</label>
    <select id="theme-select" class="form-select mb-3">
      <option value="system">System</option>
      <option value="light">Light</option>
      <option value="dark">Dark</option>
    </select>

    <div class="text-end mt-3">
      <button class="btn btn-secondary" id="close-settings">Close</button>
    </div>
  </div>
</div>

<script>
  /* ========= CSRF ========= */
  function getCSRF(){ return document.getElementById('csrf-token').value; }

  /* ========= State ========= */
  let currentConversation = null;
  let conversations = [];
  let rightClickTargetId = null;

  const chatArea = document.getElementById('chat-area');
  const inputBox = document.getElementById('input-box');
  const sendBtn = document.getElementById('send-btn');
  const convoListEl = document.getElementById('convo-list');
  const searchInput = document.getElementById('search-input');
  const loader = document.getElementById('loader');

  function el(tag, cls, text){
    const e = document.createElement(tag);
    if(cls) e.className = cls;
    if(text) e.textContent = text;
    return e;
  }

  function scrollDown(){ chatArea.scrollTop = chatArea.scrollHeight; }

  function addMessage(sender, text){
    const wrap = el('div','msg-wrapper');
    const msg = el('div','msg', text);
    if(sender==='user') msg.classList.add('user'); 
    else msg.classList.add('bot');
    wrap.appendChild(msg);
    chatArea.appendChild(wrap);
    scrollDown();
  }

  /* ========= Render Conversation List ========= */
  function renderConversations(list){
    convoListEl.innerHTML = "";
    list.forEach(c=>{
      const item = el("div","convo-item");
      item.dataset.id = c.id;

      const title = el("div","convo-title", c.title);
      const meta  = el("div","convo-meta", new Date(c.updated_at).toLocaleString());

      item.appendChild(title);
      item.appendChild(meta);

      if(currentConversation && c.id === currentConversation.id)
        item.classList.add("active");

      item.addEventListener("click", ()=> loadConversation(c.id));

      convoListEl.appendChild(item);
    });
  }

  async function fetchConversations(q=""){
    const res = await fetch("/chat/conversations/?q="+encodeURIComponent(q));
    const data = await res.json();
    conversations = data.conversations;
    renderConversations(conversations);
  }

  /* ========= New Conversation ========= */
  async function newConversation(){
    try{
      const res = await fetch("/chat/new/", {
        method:"POST",
        headers:{ "Content-Type":"application/json", "X-CSRFToken":getCSRF() },
        body: JSON.stringify({ title:"New Chat" })
      });
      const data = await res.json();

      // Set current conversation
      currentConversation = { id:data.id, title:data.title };

      // Clear old messages
      chatArea.innerHTML = "";

      document.getElementById("welcome-screen").style.display = "block";

      // Refresh left panel history
      await fetchConversations();

      // Focus input box for typing
      inputBox.focus();

    } catch(e){
      console.error('newConversation error', e);
      alert('Could not create new chat.');
    }
  }

  /* ========= Load Conversation ========= */
  async function loadConversation(id){
    loader.style.display = "block";
    const res = await fetch(`/chat/conversation/${id}/`);
    const data = await res.json();

    chatArea.innerHTML = "";
    (data.messages || []).forEach(m=>{
      addMessage(m.sender, m.message);
    });

    currentConversation = { id:data.conversation.id, title:data.conversation.title };
    renderConversations(conversations);
    loader.style.display = "none";
  }

  /* ========= Send Message ========= */
  async function sendMessage(){
    document.getElementById("welcome-screen").style.display = "none";
    const text = inputBox.value.trim();
    if(!text) return;

    addMessage("user", text);
    inputBox.value = "";
    inputBox.disabled = true;
    sendBtn.disabled  = true;
    loader.style.display = "block";

    const payload = { message:text };
    if(currentConversation) payload.conversation_id = currentConversation.id;

    try{
      const res = await fetch("/chat/ask/",{
        method:"POST",
        headers:{ "Content-Type":"application/json","X-CSRFToken":getCSRF() },
        body:JSON.stringify(payload)
      });
      const data = await res.json();
      addMessage("bot", data.reply);
      await fetchConversations();
    } catch(e){
      addMessage("bot", "âŒ Error connecting to AI.");
    }

    loader.style.display = "none";
    inputBox.disabled = false;
    sendBtn.disabled  = false;
  }

  sendBtn.addEventListener("click", sendMessage);
  inputBox.addEventListener("keydown", e=>{
    if(e.key==="Enter" && !e.shiftKey){
      e.preventDefault();
      sendMessage();
    }
  });

  /* ========= Sidebar Buttons ========= */
  document.getElementById("btn-new").addEventListener("click", newConversation);
  document.getElementById("btn-history").addEventListener("click", ()=>{
    const lp = document.getElementById("leftpanel");
    lp.style.display = lp.style.display === "none" ? "flex" : "none";
  });

  searchInput.addEventListener("input", ()=>{
    fetchConversations(searchInput.value);
  });

  /* ========= Right-click Menu ========= */
  const contextMenu = document.getElementById("context-menu");

  document.addEventListener("contextmenu", function(e){
    const item = e.target.closest(".convo-item");
    if(item){
      e.preventDefault();
      rightClickTargetId = item.dataset.id;
      contextMenu.style.left = e.pageX + "px";
      contextMenu.style.top  = e.pageY + "px";
      contextMenu.style.display = "block";
    } else {
      contextMenu.style.display = "none";
    }
  });

  document.addEventListener("click", ()=>{
    contextMenu.style.display = "none";
  });

  document.querySelectorAll("#context-menu .ctx-item").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const action = btn.dataset.action;

      if(action === "rename"){
        const newName = prompt("Enter new name:");
        if(newName && newName.trim()){
          await fetch(`/chat/rename/${rightClickTargetId}/`, {
            method:"POST",
            headers:{ "Content-Type":"application/json","X-CSRFToken":getCSRF() },
            body:JSON.stringify({ title:newName })
          });
          fetchConversations();
        }
      }

      if(action === "delete"){
        if(confirm("Delete this chat?")){
          await fetch(`/chat/delete/${rightClickTargetId}/`, {
            method:"POST",
            headers:{ "X-CSRFToken":getCSRF() }
          });
          fetchConversations();
          chatArea.innerHTML="";
        }
      }

      contextMenu.style.display = "none";
    });
  });

  /* ========= Initial Load ========= */
  (async function(){
    await fetchConversations();
    await newConversation();
  })();

  /* ===================================
    THEME HANDLING (Dark/Light/System)
    =================================== */

    // Load saved theme
    (function(){
    const saved = localStorage.getItem("theme") || "system";
    applyTheme(saved);
    document.getElementById("theme-select").value = saved;
    })();

    function applyTheme(mode){
    let body = document.body;

    if(mode === "light"){
        body.classList.add("light-mode");
        body.classList.remove("dark-mode");
        localStorage.setItem("theme", "light");
        return;
    }

    if(mode === "dark"){
        body.classList.add("dark-mode");
        body.classList.remove("light-mode");
        localStorage.setItem("theme", "dark");
        return;
    }

    // SYSTEM MODE
    const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
    if(prefersDark){
        body.classList.add("dark-mode");
        body.classList.remove("light-mode");
    } else {
        body.classList.add("light-mode");
        body.classList.remove("dark-mode");
    }
    localStorage.setItem("theme", "system");
    }

    /* Dropdown change */
    document.getElementById("theme-select").addEventListener("change", function(){
    applyTheme(this.value);
    });

    /* Settings button */
    document.getElementById("btn-settings").addEventListener("click", ()=>{
    document.getElementById("settings-modal").style.display="flex";
    });

    /* Close modal */
    document.getElementById("close-settings").addEventListener("click", ()=>{
    document.getElementById("settings-modal").style.display="none";
    });

</script>
</body>
</html>
